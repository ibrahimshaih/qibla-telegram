<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qibla Finder</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.1);
            transition: transform 0.1s ease-out;
        }
        .compass-disk {
            width: 100%;
            height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Compass_rose_en_04_02.svg/1024px-Compass_rose_en_04_02.svg.png') no-repeat center;
            background-size: contain;
            filter: invert(1) drop-shadow(0 0 2px #00ff88);
            position: absolute;
            top: 0;
            left: 0;
        }
        .qibla-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 130px;
            background: linear-gradient(to top, transparent 50%, #ff0055 50%);
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(0deg);
            z-index: 10;
            filter: drop-shadow(0 0 8px #ff0055);
            display: none;
        }
        .qibla-pointer::after {
            content: 'üïã';
            font-size: 28px;
            position: absolute;
            top: -30px;
            left: -12px;
        }
        .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }
        .info {
            margin-top: 40px;
            text-align: center;
            z-index: 20;
        }
        h1 {
            margin: 0;
            font-size: 28px;
            color: #00ff88;
        }
        p {
            color: #888;
            margin: 8px 0;
            font-size: 14px;
        }
        .btn {
            margin-top: 20px;
            padding: 14px 30px;
            background: #00ff88;
            color: #000;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }
        .error {
            color: #ff0055;
        }
    </style>
</head>
<body>
    <div class="compass-container">
        <div class="compass-disk" id="compassDisk"></div>
        <div class="qibla-pointer" id="qiblaPointer"></div>
        <div class="center-dot"></div>
    </div>
    <div class="info">
        <h1 id="angleText">--¬∞</h1>
        <p id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        <button class="btn" id="startBtn" onclick="requestPermission()">üß≠ –ö–ê–õ–ò–ë–†–û–í–ö–ê</button>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const KAABA = { lat: 21.422487, lng: 39.826206 };
        let qiblaAngle = 0;
        
        const disk = document.getElementById('compassDisk');
        const pointer = document.getElementById('qiblaPointer');
        const angleText = document.getElementById('angleText');
        const statusText = document.getElementById('statusText');
        const btn = document.getElementById('startBtn');

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const latParam = urlParams.get('lat');
            const lonParam = urlParams.get('lon');
            
            if (latParam && lonParam) {
                const lat = parseFloat(latParam);
                const lon = parseFloat(lonParam);
                
                if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                    statusText.innerText = "–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
                    statusText.classList.add('error');
                    btn.style.display = 'none';
                } else {
                    initQibla(lat, lon);
                }
            } else {
                statusText.innerText = "–ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –±–æ—Ç—É!";
                statusText.classList.add('error');
                btn.style.display = 'none';
            }
        };

        function initQibla(lat, lng) {
            qiblaAngle = calculateQibla(lat, lng);
            angleText.innerText = `–ö–∏–±–ª–∞: ${Math.round(qiblaAngle)}¬∞`;
            statusText.innerText = "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å—Ç–∞—Ä—Ç–∞";
            statusText.classList.remove('error');
            pointer.style.display = 'block';
            pointer.style.transform = `translate(-50%, -100%) rotate(${qiblaAngle}deg)`;
        }

        function calculateQibla(lat, lng) {
            const PI = Math.PI;
            const latk = KAABA.lat * PI / 180.0;
            const longk = KAABA.lng * PI / 180.0;
            const phi = lat * PI / 180.0;
            const lambda = lng * PI / 180.0;
            const y = Math.sin(longk - lambda);
            const x = Math.cos(phi) * Math.tan(latk) - Math.sin(phi) * Math.cos(longk - lambda);
            return (Math.atan2(y, x) * 180.0 / PI + 360) % 360;
        }

        function requestPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startCompass();
                        } else {
                            statusText.innerText = "–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º!";
                            statusText.classList.add('error');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        statusText.innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—Ç—á–∏–∫–∞–º";
                        statusText.classList.add('error');
                    });
            } else {
                startCompass();
            }
        }

        function startCompass() {
            btn.style.display = 'none';
            statusText.innerText = "–í—Ä–∞—â–∞–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω";
            statusText.classList.remove('error');
            
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            } else if ('ondeviceorientation' in window) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                statusText.innerText = "–ö–æ–º–ø–∞—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                statusText.classList.add('error');
            }
        }

        function handleOrientation(event) {
            let alpha = event.alpha;
            
            if (event.webkitCompassHeading) {
                alpha = event.webkitCompassHeading;
            } else if (alpha !== null) {
                alpha = 360 - alpha;
            }
            
            if (alpha == null) return;
            
            disk.style.transform = `rotate(${-alpha}deg)`;
            pointer.style.transform = `translate(-50%, -100%) rotate(${qiblaAngle - alpha}deg)`;
        }
    </script>
</body>
</html>