<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Qibla Finder</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .start-button {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 40px;
            background: linear-gradient(135deg, #ff0055, #ff6b9d);
            color: white;
            border: 2px solid #ff0055;
            border-radius: 50px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 0, 85, 0.7), 0 0 50px rgba(255, 0, 85, 0.4);
            z-index: 100;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }
        
        .start-button:active {
            transform: translateX(-50%) scale(0.95);
        }
        
        .start-button.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 25px rgba(255, 0, 85, 0.7), 0 0 50px rgba(255, 0, 85, 0.4);
            }
            50% {
                box-shadow: 0 0 35px rgba(255, 0, 85, 0.9), 0 0 70px rgba(255, 0, 85, 0.6);
            }
        }
        
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
            transition: transform 0.1s ease-out;
            margin-top: 60px;
        }
        
        .compass-disk {
            width: 100%;
            height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Compass_rose_en_04_02.svg/1024px-Compass_rose_en_04_02.svg.png') no-repeat center;
            background-size: contain;
            filter: invert(1) drop-shadow(0 0 2px #00ff88);
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .qibla-pointer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 130px;
            background: linear-gradient(to top, transparent 50%, #ff0055 50%);
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(0deg);
            z-index: 10;
            filter: drop-shadow(0 0 8px #ff0055);
            display: none;
        }
        
        .qibla-pointer::after {
            content: 'üïã';
            font-size: 28px;
            position: absolute;
            top: -30px;
            left: -12px;
        }
        
        .center-dot {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }
        
        .info {
            margin-top: 40px;
            text-align: center;
            z-index: 20;
        }
        
        h1 {
            margin: 0;
            font-size: 32px;
            color: #00ff88;
            text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88;
            font-weight: bold;
        }
        
        p {
            color: #aaa;
            margin: 12px 0;
            font-size: 16px;
        }
        
        .error {
            color: #ff0055;
        }
    </style>
</head>
<body>
    <button class="start-button" id="startButton">üöÄ –°–¢–ê–†–¢</button>
    
    <div class="compass-container">
        <div class="compass-disk" id="compassDisk"></div>
        <div class="qibla-pointer" id="qiblaPointer"></div>
        <div class="center-dot"></div>
    </div>
    
    <div class="info">
        <h1 id="angleText">--¬∞</h1>
        <p id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const KAABA = { lat: 21.422487, lng: 39.826206 };
        let qiblaAngle = 0;
        
        const disk = document.getElementById('compassDisk');
        const pointer = document.getElementById('qiblaPointer');
        const angleText = document.getElementById('angleText');
        const statusText = document.getElementById('statusText');
        const startButton = document.getElementById('startButton');

        // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        startButton.classList.add('hidden');

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const latParam = urlParams.get('lat');
            const lonParam = urlParams.get('lon');
            
            if (latParam && lonParam) {
                const lat = parseFloat(latParam);
                const lon = parseFloat(lonParam);
                
                if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
                    statusText.innerText = "–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
                    statusText.classList.add('error');
                } else {
                    initQibla(lat, lon);
                }
            } else {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
                requestGeolocation();
            }
        };

        function requestGeolocation() {
            statusText.innerText = "–ó–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏...";
            
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        initQibla(lat, lon);
                    },
                    function(error) {
                        statusText.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é";
                        statusText.classList.add('error');
                        console.error("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                statusText.innerText = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                statusText.classList.add('error');
            }
        }

        function initQibla(lat, lng) {
            qiblaAngle = calculateQibla(lat, lng);
            angleText.innerText = `–ö–∏–±–ª–∞: ${Math.round(qiblaAngle)}¬∞`;
            statusText.innerText = "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –°–¢–ê–†–¢";
            statusText.classList.remove('error');
            pointer.style.display = 'block';
            pointer.style.transform = `translate(-50%, -100%) rotate(${qiblaAngle}deg)`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –°–¢–ê–†–¢
            startButton.classList.remove('hidden');
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
            startButton.onclick = function() {
                startButton.classList.add('hidden');
                requestPermission();
            };
        }

        function calculateQibla(lat, lng) {
            const PI = Math.PI;
            const latk = KAABA.lat * PI / 180.0;
            const longk = KAABA.lng * PI / 180.0;
            const phi = lat * PI / 180.0;
            const lambda = lng * PI / 180.0;
            const y = Math.sin(longk - lambda);
            const x = Math.cos(phi) * Math.tan(latk) - Math.sin(phi) * Math.cos(longk - lambda);
            return (Math.atan2(y, x) * 180.0 / PI + 360) % 360;
        }

        function requestPermission() {
            statusText.innerText = "–ó–∞–ø—É—Å–∫ –∫–æ–º–ø–∞—Å–∞...";
            
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            startCompass();
                        } else {
                            statusText.innerText = "‚ùå –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞—Ç—á–∏–∫–∞–º!";
                            statusText.classList.add('error');
                            startButton.classList.remove('hidden');
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        statusText.innerText = "‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞";
                        statusText.classList.add('error');
                        startButton.classList.remove('hidden');
                    });
            } else {
                startCompass();
            }
        }

        function startCompass() {
            statusText.innerText = "üß≠ –í—Ä–∞—â–∞–π—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω";
            statusText.classList.remove('error');
            
            if ('ondeviceorientationabsolute' in window) {
                window.addEventListener('deviceorientationabsolute', handleOrientation);
            } else if ('ondeviceorientation' in window) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                statusText.innerText = "‚ùå –ö–æ–º–ø–∞—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
                statusText.classList.add('error');
            }
        }

        function handleOrientation(event) {
            let alpha = event.alpha;
            
            if (event.webkitCompassHeading) {
                alpha = event.webkitCompassHeading;
            } else if (alpha !== null) {
                alpha = 360 - alpha;
            }
            
            if (alpha == null) return;
            
            disk.style.transform = `rotate(${-alpha}deg)`;
            pointer.style.transform = `translate(-50%, -100%) rotate(${qiblaAngle - alpha}deg)`;
        }
    </script>
</body>
</html>
